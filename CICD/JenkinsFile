pipeline {
    agent any

    tools {
        jdk "JDK17"
        maven "MAVEN3.9"
    }

    environment {
        // Nexus configuration
        NEXUS_VERSION       = "nexus3"
        NEXUS_PROTOCOL      = "http"
        NEXUS_URL           = "172.31.40.209:8081"
        NEXUS_REPOSITORY    = "release-repo"
        NEXUS_CREDENTIAL_ID = "nexuslogin"

        // Artifact versioning
        ARTVERSION = "${env.BUILD_ID}"

        // SonarQube
        SCANNER_HOME = tool 'sonarscanner4'

        // Notification
        EMAIL_RECIPIENTS = "devops-team@example.com"
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 30, unit: 'MINUTES')
        ansiColor('xterm')
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build') {
            steps {
                sh 'mvn clean install -DskipTests'
            }
            post {
                success {
                    archiveArtifacts artifacts: '**/target/*.war', allowEmptyArchive: true
                }
            }
        }

        stage('Test & Code Quality') {
            parallel {

                stage('Unit Tests') {
                    steps {
                        sh 'mvn test'
                    }
                }

                stage('Integration Tests') {
                    steps {
                        sh 'mvn verify -DskipUnitTests'
                    }
                }

                stage('Checkstyle Analysis') {
                    steps {
                        sh 'mvn checkstyle:checkstyle'
                    }
                }

                stage('SonarQube Analysis') {
                    steps {
                        withSonarQubeEnv('sonar-pro') {
                            sh """
                                ${SCANNER_HOME}/bin/sonar-scanner \
                                -Dsonar.projectKey=ci-cd-portfolio \
                                -Dsonar.projectName=CI-CD-Portfolio \
                                -Dsonar.projectVersion=1.0 \
                                -Dsonar.sources=src/main/java \
                                -Dsonar.java.binaries=target/classes \
                                -Dsonar.junit.reportsPath=target/surefire-reports \
                                -Dsonar.jacoco.reportPaths=target/jacoco.exec \
                                -Dsonar.java.checkstyle.reportPaths=target/checkstyle-result.xml
                            """
                        }

                        timeout(time: 10, unit: 'MINUTES') {
                            waitForQualityGate abortPipeline: true
                        }
                    }
                }
            }
        }

        stage('Publish to Nexus') {
            steps {
                script {
                    def pom = readMavenPom file: "pom.xml"
                    def artifactFiles = findFiles(glob: "target/*.${pom.packaging}")

                    if (artifactFiles.length == 0) {
                        error "No build artifact found!"
                    }

                    nexusArtifactUploader(
                        nexusVersion: NEXUS_VERSION,
                        protocol: NEXUS_PROTOCOL,
                        nexusUrl: NEXUS_URL,
                        groupId: pom.groupId,
                        version: ARTVERSION,
                        repository: NEXUS_REPOSITORY,
                        credentialsId: NEXUS_CREDENTIAL_ID,
                        artifacts: [
                            [artifactId: pom.artifactId, file: artifactFiles[0].path, type: pom.packaging],
                            [artifactId: pom.artifactId, file: "pom.xml", type: "pom"]
                        ]
                    )
                }
            }
        }

        stage('Docker Build & Push (Optional)') {
            when {
                expression { fileExists('Dockerfile') }
            }
            steps {
                script {
                    def imageName = "ci-cd-portfolio:${ARTVERSION}"
                    sh "docker build -t ${imageName} ."
                    sh "docker push ${imageName}"
                }
            }
        }
    }

    /* =========================
       POST ACTIONS & NOTIFICATIONS
       ========================= */
    post {

        success {
            mail(
                to: EMAIL_RECIPIENTS,
                subject: "Jenkins Build SUCCESS - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
                Build Status : SUCCESS
                Job Name     : ${env.JOB_NAME}
                Build Number : ${env.BUILD_NUMBER}
                Artifact Ver : ${ARTVERSION}

                View Build:
                ${env.BUILD_URL}
                """
            )
        }

        failure {
            mail(
                to: EMAIL_RECIPIENTS,
                subject: "Jenkins Build FAILED - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
                Build Status : FAILED
                Job Name     : ${env.JOB_NAME}
                Build Number : ${env.BUILD_NUMBER}

                Please check the console output:
                ${env.BUILD_URL}
                """
            )
        }

        always {
            cleanWs()
        }
    }
}
